<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restablecer contraseña | Bookea</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        min-height: 100vh;
        display: grid;
        place-items: center;
        background: #f7f7f8;
      }
      .card {
        width: 100%;
        max-width: 420px;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      }
    </style>
  </head>
  <body>
    <div class="card p-4">
      <h1 class="h5 text-center mb-3">Restablecer contraseña</h1>
      <p class="small text-muted">
        Ingresá tu nueva contraseña para tu cuenta de Bookea.
      </p>

      <form id="form-reset">
        <div class="mb-3">
          <label class="form-label">Nueva contraseña</label>
          <input
            type="password"
            id="new-password"
            class="form-control"
            required
            minlength="6"
            placeholder="Mínimo 6 caracteres"
          />
        </div>
        <div class="mb-3">
          <label class="form-label">Confirmar contraseña</label>
          <input
            type="password"
            id="new-password-2"
            class="form-control"
            required
            minlength="6"
            placeholder="Repetí la contraseña"
          />
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-dark">
            Actualizar contraseña
          </button>
        </div>
      </form>

      <div id="msg" class="alert mt-3 d-none" role="alert"></div>
    </div>

    <script type="module">
      import { supabase } from "./supabaseClient.js";

      const form = document.getElementById("form-reset");
      const msg = document.getElementById("msg");

      function showMsg(text, type = "success") {
        msg.className = `alert alert-${type} mt-3`;
        msg.textContent = text;
        msg.classList.remove("d-none");
      }

      // Este hash llega desde el mail: #access_token=...&type=recovery
      const isRecovery = location.hash.includes("type=recovery");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const p1 = document.getElementById("new-password").value.trim();
        const p2 = document.getElementById("new-password-2").value.trim();

        if (p1.length < 6)
          return showMsg(
            "La contraseña debe tener al menos 6 caracteres.",
            "warning"
          );
        if (p1 !== p2)
          return showMsg("Las contraseñas no coinciden.", "warning");

        try {
          // Supabase crea una sesión temporal si venís del link de recuperación
          const { data: sessionData } = await supabase.auth.getSession();
          if (!sessionData?.session || !isRecovery) {
            return showMsg(
              "El enlace de recuperación no es válido o expiró. Volvé a solicitarlo.",
              "danger"
            );
          }

          const { error } = await supabase.auth.updateUser({ password: p1 });
          if (error) throw error;

          showMsg(
            "¡Listo! Tu contraseña se actualizó. Te llevamos al inicio de sesión…",
            "success"
          );
          setTimeout(() => (location.href = "/login.html"), 1500);
        } catch (err) {
          console.error(err);
          showMsg(
            "No pudimos actualizar la contraseña. Probá nuevamente.",
            "danger"
          );
        }
      });
    </script>
  </body>
</html>
